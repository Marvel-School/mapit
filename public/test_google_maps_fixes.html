<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Fix Verification - MapIt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .test-status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-pending { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .map-container { height: 300px; border: 1px solid #ddd; margin: 10px 0; }
        .console-output { 
            background: #000; color: #0f0; font-family: monospace; 
            padding: 10px; height: 200px; overflow-y: scroll; 
            white-space: pre-wrap; font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-vial"></i> Google Maps API Fix Verification</h1>
        <p class="lead">Testing all Google Maps API fixes in Docker environment</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-check-circle"></i> Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-csp" class="test-status test-pending">
                            <strong>CSP Headers:</strong> <span id="csp-result">Testing...</span>
                        </div>
                        <div id="test-scripts" class="test-status test-pending">
                            <strong>Script Loading:</strong> <span id="scripts-result">Testing...</span>
                        </div>
                        <div id="test-images" class="test-status test-pending">
                            <strong>Image Assets:</strong> <span id="images-result">Testing...</span>
                        </div>
                        <div id="test-maps" class="test-status test-pending">
                            <strong>Google Maps API:</strong> <span id="maps-result">Testing...</span>
                        </div>
                        <div id="test-performance" class="test-status test-pending">
                            <strong>Performance Warnings:</strong> <span id="performance-result">Testing...</span>
                        </div>
                        <div id="test-functions" class="test-status test-pending">
                            <strong>JavaScript Functions:</strong> <span id="functions-result">Testing...</span>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-map"></i> Map Test</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-map" class="map-container"></div>
                        <button id="test-markers" class="btn btn-primary">Test Advanced Markers</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Console Output</h5>
                    </div>
                    <div class="card-body">
                        <div id="console-output" class="console-output"></div>
                        <button id="clear-console" class="btn btn-sm btn-secondary mt-2">Clear</button>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-bug"></i> Error Detection</h5>
                    </div>
                    <div class="card-body">
                        <div id="error-count" class="alert alert-info">
                            Console Errors: <span id="error-counter">0</span>
                        </div>
                        <div id="error-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Test tracking
        let testResults = {
            csp: false,
            scripts: false,
            images: false,
            maps: false,
            performance: false,
            functions: false
        };
        
        let errorCount = 0;
        let consoleOutput = document.getElementById('console-output');
        let errorList = document.getElementById('error-list');
        
        // Console capture
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        function logToDisplay(type, ...args) {
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            
            consoleOutput.textContent += logEntry;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            if (type === 'error') {
                errorCount++;
                document.getElementById('error-counter').textContent = errorCount;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-sm';
                errorDiv.textContent = `${timestamp}: ${message}`;
                errorList.appendChild(errorDiv);
            }
        }
        
        // Override console methods
        console.log = (...args) => { originalConsole.log(...args); logToDisplay('log', ...args); };
        console.error = (...args) => { originalConsole.error(...args); logToDisplay('error', ...args); };
        console.warn = (...args) => { originalConsole.warn(...args); logToDisplay('warn', ...args); };
        console.info = (...args) => { originalConsole.info(...args); logToDisplay('info', ...args); };
        
        // Clear console
        document.getElementById('clear-console').addEventListener('click', () => {
            consoleOutput.textContent = '';
            errorList.innerHTML = '';
            errorCount = 0;
            document.getElementById('error-counter').textContent = '0';
        });
        
        // Test functions
        function updateTestStatus(testName, passed, message) {
            const element = document.getElementById(`test-${testName}`);
            const resultElement = document.getElementById(`${testName}-result`);
            
            element.className = 'test-status ' + (passed ? 'test-pass' : 'test-fail');
            resultElement.textContent = message;
            testResults[testName] = passed;
        }
        
        // Test 1: CSP Headers
        function testCSP() {
            try {
                // Test if Bootstrap and Font Awesome loaded
                const bootstrapLoaded = typeof bootstrap !== 'undefined';
                const fontAwesomeLoaded = document.querySelector('.fa') !== null;
                
                if (bootstrapLoaded && fontAwesomeLoaded) {
                    updateTestStatus('csp', true, 'CDN resources loaded successfully');
                } else {
                    updateTestStatus('csp', false, 'CDN resources blocked by CSP');
                }
            } catch (error) {
                updateTestStatus('csp', false, `CSP test error: ${error.message}`);
            }
        }
        
        // Test 2: Script Loading
        function testScripts() {
            const scripts = [
                '/js/main.js',
                '/js/docker-maps-loader.js',
                '/js/destinations-map.js'
            ];
            
            let loadedScripts = 0;
            
            scripts.forEach(src => {
                const script = Array.from(document.scripts).find(s => s.src.includes(src));
                if (script) loadedScripts++;
            });
            
            if (loadedScripts === scripts.length) {
                updateTestStatus('scripts', true, 'All MapIt scripts loaded');
            } else {
                updateTestStatus('scripts', false, `Only ${loadedScripts}/${scripts.length} scripts loaded`);
            }
        }
        
        // Test 3: Image Assets
        function testImages() {
            const testImages = [
                '/images/world-map.svg',
                '/images/destination-placeholder.svg',
                '/images/cta-bg.svg'
            ];
            
            let loadedImages = 0;
            let totalImages = testImages.length;
            
            testImages.forEach(src => {
                const img = new Image();
                img.onload = () => {
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        updateTestStatus('images', true, 'All image assets available');
                    }
                };
                img.onerror = () => {
                    totalImages--;
                    if (loadedImages === totalImages) {
                        updateTestStatus('images', false, `${totalImages - loadedImages} images failed to load`);
                    }
                };
                img.src = src;
            });
        }
        
        // Test 4: Google Maps API
        function testGoogleMaps() {
            if (typeof google !== 'undefined' && google.maps) {
                updateTestStatus('maps', true, 'Google Maps API loaded successfully');
                initTestMap();
            } else {
                updateTestStatus('maps', false, 'Google Maps API not available');
                setTimeout(testGoogleMaps, 2000); // Retry in 2 seconds
            }
        }
        
        // Test 5: Performance Warnings
        function testPerformance() {
            // Check for common performance issues
            const performanceIssues = [];
            
            // Check for multiple Maps API loads
            const mapsScripts = Array.from(document.scripts).filter(s => 
                s.src.includes('maps.googleapis.com')
            );
            
            if (mapsScripts.length > 1) {
                performanceIssues.push('Multiple Maps API script tags detected');
            }
            
            // Check for loading=async parameter
            const hasAsyncParam = mapsScripts.some(s => s.src.includes('loading=async'));
            if (!hasAsyncParam && mapsScripts.length > 0) {
                performanceIssues.push('Maps API missing loading=async parameter');
            }
            
            if (performanceIssues.length === 0) {
                updateTestStatus('performance', true, 'No performance warnings detected');
            } else {
                updateTestStatus('performance', false, performanceIssues.join(', '));
            }
        }
        
        // Test 6: JavaScript Functions
        function testFunctions() {
            const requiredFunctions = [
                'initializeGoogleMaps',
                'waitForGoogleMaps',
                'initializeDestinationSelectors'
            ];
            
            const missingFunctions = requiredFunctions.filter(func => 
                typeof window[func] !== 'function'
            );
            
            if (missingFunctions.length === 0) {
                updateTestStatus('functions', true, 'All required functions available');
            } else {
                updateTestStatus('functions', false, `Missing: ${missingFunctions.join(', ')}`);
            }
        }
        
        // Initialize test map
        function initTestMap() {
            try {
                const map = new google.maps.Map(document.getElementById('test-map'), {
                    center: { lat: 40.7128, lng: -74.0060 },
                    zoom: 10,
                    mapId: 'MAPIT_TEST_MAP'
                });
                
                console.log('Test map initialized successfully');
                
                // Test Advanced Markers
                document.getElementById('test-markers').addEventListener('click', () => {
                    testAdvancedMarkers(map);
                });
                
            } catch (error) {
                console.error('Error initializing test map:', error);
            }
        }
        
        // Test Advanced Markers
        function testAdvancedMarkers(map) {
            try {
                if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                    const marker = new google.maps.marker.AdvancedMarkerElement({
                        position: { lat: 40.7128, lng: -74.0060 },
                        map: map,
                        title: 'Test Advanced Marker'
                    });
                    console.log('Advanced Marker created successfully');
                } else {
                    console.warn('Advanced Marker API not available, using fallback');
                    const marker = new google.maps.Marker({
                        position: { lat: 40.7128, lng: -74.0060 },
                        map: map,
                        title: 'Test Legacy Marker'
                    });
                }
            } catch (error) {
                console.error('Error creating marker:', error);
            }
        }
        
        // Run tests when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Starting Google Maps fix verification tests...');
            
            // Run tests with delays to allow loading
            setTimeout(testCSP, 100);
            setTimeout(testScripts, 200);
            setTimeout(testImages, 300);
            setTimeout(testGoogleMaps, 1000);
            setTimeout(testPerformance, 2000);
            setTimeout(testFunctions, 2500);
            
            // Final summary
            setTimeout(() => {
                const passedTests = Object.values(testResults).filter(Boolean).length;
                const totalTests = Object.keys(testResults).length;
                console.log(`Test Summary: ${passedTests}/${totalTests} tests passed`);
                
                if (passedTests === totalTests) {
                    console.log('✅ All Google Maps fixes are working correctly!');
                } else {
                    console.log('❌ Some issues remain. Check test results above.');
                }
            }, 5000);
        });
    </script>
    
    <!-- Load MapIt scripts to test -->
    <script src="/js/main.js"></script>
    <script src="/js/docker-maps-loader.js"></script>
    <script src="/js/destinations-map.js"></script>
</body>
</html>
